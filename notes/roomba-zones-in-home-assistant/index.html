<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Roomba zones in Home Assistant | Jeff Fredrickson</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <meta name="theme-color" content="">

    <script defer data-domain="retro.ejeff.org" src="https://plausible.tensouth.net/js/script.js"></script><link rel="stylesheet" href="/css/tailwind.fff28b5c4789a2cf3d28adb0ac5e83ea4c20a867893ee9466bab02e4ab11a189.min.css"><link rel="stylesheet" href="/css/main.css">
  </head>
  <body>

    <div class="m-2"><div class="text-center">
  <h1>Jeff Fredrickson</h1>

  <a class="" href="/">Home</a>
  
    - <a class="" href="/notes/">Notes</a>
  
    - <a class="" href="/projects/">Projects</a>
  
    - <a class="" href="/contact/">Contact</a>
  
  <hr>
</div><div class="mb-2"><h1>Roomba zones in Home Assistant</h1>

  <strong>How to refer to custom Roomba zones in Home Assistant scripts</strong>

<div>
  <span class="text-sm">
    [<span class="italic">Tagged:
      <a href="/tags/smart-home/">smart-home</a>, <a href="/tags/home-assistant/">home-assistant</a>, <a href="/tags/iot/">iot</a></span>]
  </span>

</div>
</div>
<main id="main" class="main">
  <p>There doesn&rsquo;t appear to be a straightforward way to have Home Assistant work with custom Roomba zones. It takes some legwork.</p>
<p>I&rsquo;ve designated a Roomba zone around our <a href="https://www.litter-robot.com/">Litter-Robot</a> with the intention of having the vacuum clean up any stray litter after one of the cats uses the litter box.</p>
<p>But in order to get a Home Assistant script to send the Roomba to that zone, I need to know the Roomba&rsquo;s <code>pmap_id</code> and <code>region_id</code> fields from the iRobot API. Fortunately, <a href="https://github.com/koalazak/dorita980">dorita980</a> makes this easy by providing a JavaScript wrapper around the iRobot API.</p>
<h2 id="steps">Steps</h2>
<p>First, you&rsquo;ll need to know your Roomba&rsquo;s IP address. Your router&rsquo;s DHCP lease table typically has this information.</p>
<p>In Home Assistant, if the <a href="https://www.home-assistant.io/integrations/roomba/">Roomba integration</a> has continuous mode enabled, turn it off. The continuous mode option can be found by going to Settings -&gt; Devices &amp; Services -&gt; Integrations and clicking Configure under the Roomba integration. This tells Home Assistant to stop hitting the Roomba&rsquo;s local API. The Roomba API can only handle one connection at a time, and we&rsquo;ll need to have access to it.</p>
<p><a href="https://homesupport.irobot.com/s/article/28252">Set up a new clean zone</a> in the Roomba app if you haven&rsquo;t already done so.</p>
<p>Install <a href="https://github.com/jfredrickson/irobot-tools">irobot-tools</a>. This will include the dorita980 library, which in turn includes a handy script to find your Roomba&rsquo;s local API authentication data. It gets this by looking it up in the iRobot cloud service using your iRobot username and password:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npx get-roomba-password-cloud &lt;your iRobot username&gt; &lt;your iRobot password&gt;</span></span></code></pre></div><p>This will output something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Found 1 robot(s)!
</span></span><span class="line"><span class="cl">Robot &#34;Roomba&#34; (sku: i855020 SoftwareVer: lewis+22.21.1+2022-06-02-570490a425b+Firmware-Build+1339):
</span></span><span class="line"><span class="cl">BLID=&gt; ABCDEF0123456789ABCDEF0123456789
</span></span><span class="line"><span class="cl">Password=&gt; :1:0123456789:acbdefghijklmnop &lt;= Yes, all this string.</span></span></code></pre></div><p>There&rsquo;s your BLID and password! This BLID and password will be used in the next step to authenticate to the Roomba&rsquo;s local API.</p>
<p>Use iRobot&rsquo;s app on your mobile device to tell the Roomba to start vacuuming your custom zone. Immediately after it starts, use this script from <code>irobot-tools</code> to find the last command that was issued to the Roomba:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./get-last-command &lt;BLID&gt; &lt;password&gt; &lt;IP address&gt;</span></span></code></pre></div><p>Example output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;command&#34;</span><span class="p">:</span> <span class="s2">&#34;start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;initiator&#34;</span><span class="p">:</span> <span class="s2">&#34;rmtApp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;time&#34;</span><span class="p">:</span> <span class="mi">1658690508</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;favorite_id&#34;</span><span class="p">:</span> <span class="s2">&#34;0123456789abcdef0123456789abcdef&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;robot_id&#34;</span><span class="p">:</span> <span class="s2">&#34;ABCDEF0123456789ABCDEF0123456789&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pmap_id&#34;</span><span class="p">:</span> <span class="s2">&#34;b1x9ivlRXq1N7JfLcywbRV&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;regions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;noAutoPasses&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;twoPass&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;region_id&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;zid&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_pmapv_id&#34;</span><span class="p">:</span> <span class="s2">&#34;220724T170713&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ordered&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>And there&rsquo;s the <code>pmap_id</code> and <code>region_id</code>.</p>
<p>At this point, you can now restore continuous mode in Home Assistant.</p>
<p>Now in Home Assistant, you can create a script to tell the Roomba to vacuum this custom zone. The script should include a sequence item containing:</p>
<ul>
<li><strong>Action type:</strong> Call service</li>
<li><strong>Service:</strong> Vacuum: Send command</li>
<li><strong>Targets:</strong> (select your Roomba)</li>
<li><strong>Command:</strong> start</li>
<li><strong>Parameters:</strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">pmap_id</span><span class="p">:</span><span class="w"> </span><span class="l">b1x9ivlRXq1N7JfLcywbRV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">regions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">region_id</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">zid</span></span></span></code></pre></div></li>
</ul>

</main><div class="text-center">
  <hr>
  <div>
    <a href="https://github.com/jfredrickson/jfredrickson.github.io"><img class="inline" src="/images/github.gif" alt="Fork this on GitHub"></a>
    <a href="https://www.webdesignmuseum.org/old-software/web-browsers/netscape-navigator-2-0"><img class="inline" src="/images/netscape-2.0.gif" alt="Netscape Now! 2.0"></a>
  </div>
  <div>
    <a href="https://ejeff.org/notes/roomba-zones-in-home-assistant/">Go modern</a>
  </div>
</div>
</div>

  </body>
</html>
